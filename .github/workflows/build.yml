name: Build iOS 15 Tweak
on: [push]

jobs:
  build:
    runs-on: macos-latest
    steps:
      - name: 拉取代码
        uses: actions/checkout@v4

      - name: 安装基础工具
        run: |
          xcode-select --install || true
          brew install ldid dpkg

      - name: 安装 Theos 并使用内置兼容 SDK
        run: |
          # 克隆 Theos 主仓库
          git clone --recursive https://github.com/theos/theos.git $HOME/theos
          
          # 使用 Theos 自带的最低兼容 iOS 15 的 SDK（自动处理版本）
          # 若内置 SDK 缺失，则创建软链接指向系统现有 SDK
          if [ ! -d "$HOME/theos/sdks" ]; then
            mkdir -p $HOME/theos/sdks
            # 链接系统中已有的 iOS SDK（可能高于 15，但兼容）
            ln -s $(xcode-select -p)/Platforms/iPhoneOS.platform/Developer/SDKs/iPhoneOS.sdk $HOME/theos/sdks/iPhoneOS15.0.sdk
          fi
          
          # 强制确认 SDK 路径
          SDK_PATH="$HOME/theos/sdks/iPhoneOS15.0.sdk"
          if [ ! -d "$SDK_PATH" ]; then
            echo "错误：无法找到可用的 iOS SDK，使用系统默认"
            SDK_PATH=$(xcode-select -p)/Platforms/iPhoneOS.platform/Developer/SDKs/iPhoneOS.sdk
          fi
          echo "SDK_PATH=$SDK_PATH" >> $GITHUB_ENV

      - name: 编译插件（放宽版本校验）
        run: |
          # 忽略 SDK 版本严格匹配，强制编译
          make clean THEOS="$HOME/theos"
          make package THEOS="$HOME/theos" SDKROOT="${{ env.SDK_PATH }}" TARGET=iphone:clang:latest:15.0

      - name: 上传产物
        uses: actions/upload-artifact@v4
        with:
          name: ios15-tweak-deb
          path: packages/*.deb
