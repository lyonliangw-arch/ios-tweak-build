name: Build iOS 15 Tweak
on: [push]

jobs:
  build:
    runs-on: macos-latest
    steps:
      - name: 拉取代码
        uses: actions/checkout@v4

      - name: 安装必要工具（不含 clang，系统已自带）
        run: |
          xcode-select --install || true  # 确保命令行工具可用
          brew install ldid dpkg  # 仅安装缺失的签名和打包工具

      - name: 准备编译环境
        run: |
          # 获取系统内置 iOS SDK 路径（兼容 iOS 15）
          SDK_PATH=$(xcode-select -p)/Platforms/iPhoneOS.platform/Developer/SDKs/iPhoneOS.sdk
          echo "SDK_PATH=$SDK_PATH" >> $GITHUB_ENV
          
          # 克隆 Theos 获取头文件（用于 Logos 语法）
          git clone --depth 1 https://github.com/theos/theos.git $HOME/theos
          cp -r $HOME/theos/vendor/include/* /usr/local/include/
          
          # 下载 ElleKit（替代 substrate，iOS 15 兼容）
          mkdir -p $HOME/lib
          curl -fL --insecure https://github.com/coolstar/ElleKit/releases/download/1.1.1/ElleKit.framework.zip -o $HOME/ElleKit.framework.zip
          unzip -q $HOME/ElleKit.framework.zip -d $HOME/
          cp $HOME/ElleKit.framework/ElleKit $HOME/lib/libsubstrate.dylib
          cp $HOME/ElleKit.framework/Headers/ElleKit.h /usr/local/include/substrate.h

      - name: 手动编译插件（使用系统自带 clang）
        run: |
          # 直接调用系统 clang 编译（无需额外安装）
          clang -dynamiclib -arch arm64 -isysroot ${{ env.SDK_PATH }} \
          -framework Foundation -framework UIKit \
          -I/usr/local/include -L$HOME/lib \
          -lsubstrate -fobjc-arc -x objective-c++ \
          Tweak.xm -o VirtualCamera.dylib
          
          # 签名动态库
          ldid -S VirtualCamera.dylib
          
          # 打包成 deb
          mkdir -p packages/DEBIAN
          mkdir -p packages/Library/MobileSubstrate/DynamicLibraries
          cp VirtualCamera.dylib packages/Library/MobileSubstrate/DynamicLibraries/
          cp control packages/DEBIAN/
          dpkg-deb -b packages VirtualCamera_1.0.0_iphoneos-arm64.deb

      - name: 上传产物
        uses: actions/upload-artifact@v4
        with:
          name: ios15-tweak-deb
          path: ./*.deb
