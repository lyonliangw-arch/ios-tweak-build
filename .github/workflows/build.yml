name: Build Tweak
on: [push]

jobs:
  build:
    runs-on: macos-latest
    steps:
      - name: 拉取代码
        uses: actions/checkout@v4

      - name: 安装预编译 Theos（避免克隆问题）
        run: |
          # 下载预编译的 Theos 包（包含所有子模块，稳定可靠）
          curl -L https://github.com/theos/theos/releases/download/20230505/theos.tar.xz -o $HOME/theos.tar.xz
          # 解压到用户目录
          mkdir -p $HOME/theos
          tar -xJf $HOME/theos.tar.xz -C $HOME/theos
          
          # 验证关键文件是否存在（确保 master/tweak.mk 存在）
          if [ ! -f "$HOME/theos/makefiles/master/tweak.mk" ]; then
            echo "错误：预编译包缺失关键文件"
            ls -R $HOME/theos/makefiles
            exit 1
          fi
          echo "Theos 安装成功"

      - name: 安装依赖工具
        run: |
          brew install ldid
          brew install make

      - name: 编译插件
        run: |
          make clean THEOS="$HOME/theos"
          make package THEOS="$HOME/theos"

      - name: 上传产物
        uses: actions/upload-artifact@v4
        with:
          name: tweak-deb
          path: packages/*.deb
