name: Build iOS 15 Tweak
on: [push]

jobs:
  build:
    runs-on: macos-latest
    steps:
      - name: 拉取代码
        uses: actions/checkout@v4

      - name: 安装 Xcode 及内置 iOS SDK
        run: |
          # 安装 Xcode 13（包含 iOS 15 SDK，与 GitHub 环境兼容）
          xcode-select -s /Applications/Xcode_13.app || true
          # 验证 iOS 15 SDK 是否存在（Xcode 内置路径）
          SDK_PATH="/Applications/Xcode_13.app/Contents/Developer/Platforms/iPhoneOS.platform/Developer/SDKs/iPhoneOS15.0.sdk"
          if [ ! -d "$SDK_PATH" ]; then
            echo "错误：Xcode 未包含 iOS 15 SDK，尝试另一版本"
            xcode-select -s /Applications/Xcode_13.2.1.app
            SDK_PATH="/Applications/Xcode_13.2.1.app/Contents/Developer/Platforms/iPhoneOS.platform/Developer/SDKs/iPhoneOS15.2.sdk"
          fi
          # 确认 SDK 路径有效
          if [ ! -d "$SDK_PATH" ]; then
            echo "错误：未找到 iOS 15 相关 SDK"
            exit 1
          fi
          echo "找到 iOS SDK：$SDK_PATH"
          echo "SDK_PATH=$SDK_PATH" >> $GITHUB_ENV  # 保存路径到环境变量

      - name: 安装 Theos 及依赖
        run: |
          git clone --recursive https://github.com/theos/theos.git $HOME/theos
          cd $HOME/theos && git submodule update --init --recursive
          brew install ldid dpkg

      - name: 编译插件（使用 Xcode 内置 SDK）
        run: |
          make clean THEOS="$HOME/theos"
          make package THEOS="$HOME/theos" SDKROOT="${{ env.SDK_PATH }}"

      - name: 上传产物
        uses: actions/upload-artifact@v4
        with:
          name: ios15-tweak-deb
          path: packages/*.deb
