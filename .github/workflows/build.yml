name: Build iOS 15 Tweak
on: [push]

jobs:
  build:
    runs-on: macos-latest
    steps:
      - name: 拉取代码
        uses: actions/checkout@v4

      - name: 安装基础工具
        run: |
          xcode-select --install || true
          brew install ldid dpkg

      - name: 安装 Theos 并手动下载 iOS 15 SDK
        run: |
          # 克隆 Theos 主仓库
          git clone --recursive https://github.com/theos/theos.git $HOME/theos
          
          # 手动创建 SDK 目录
          mkdir -p $HOME/theos/sdks
          
          # 下载 iOS 15.0 SDK（使用可靠的第三方备份）
          curl -fL https://github.com/DevForYouTeam/iOS-SDKs/raw/main/iPhoneOS15.0.sdk.tar.xz -o $HOME/theos/sdks/iPhoneOS15.0.sdk.tar.xz || \
          curl -fL https://mirror.ghproxy.com/https://github.com/xybp888/iOS-SDKs/raw/master/iPhoneOS15.0.sdk.tar.xz -o $HOME/theos/sdks/iPhoneOS15.0.sdk.tar.xz
          
          # 解压 SDK
          tar -xJf $HOME/theos/sdks/iPhoneOS15.0.sdk.tar.xz -C $HOME/theos/sdks
          
          # 验证 SDK 是否存在
          SDK_PATH="$HOME/theos/sdks/iPhoneOS15.0.sdk"
          if [ ! -d "$SDK_PATH" ]; then
            echo "错误：iOS 15.0 SDK 解压失败"
            exit 1
          fi
          echo "SDK_PATH=$SDK_PATH" >> $GITHUB_ENV

      - name: 编译插件
        run: |
          make clean THEOS="$HOME/theos"
          make package THEOS="$HOME/theos" SDKROOT="${{ env.SDK_PATH }}"

      - name: 上传产物
        uses: actions/upload-artifact@v4
        with:
          name: ios15-tweak-deb
          path: packages/*.deb
