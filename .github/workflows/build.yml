name: Build Tweak
on: [push]

jobs:
  build:
    runs-on: macos-latest
    steps:
      - name: 拉取代码
        uses: actions/checkout@v4

      - name: 手动搭建 Theos 核心环境
        run: |
          # 创建 Theos 基础目录
          mkdir -p $HOME/theos/makefiles/master
          
          # 手动写入关键文件 tweak.mk（从官方仓库提取的核心内容）
          cat > $HOME/theos/makefiles/tweak.mk << 'EOF'
          include $(THEOS_MAKE_PATH)/master/tweak.mk
          EOF
          
          # 手动写入 master/tweak.mk（基础编译规则）
          cat > $HOME/theos/makefiles/master/tweak.mk << 'EOF'
          TWEAK_NAME ?= $(PROJECT_NAME)
          $(TWEAK_NAME)_FILES ?= Tweak.xm
          $(TWEAK_NAME)_FRAMEWORKS ?=
          $(TWEAK_NAME)_LIBRARIES ?= substrate
          include $(THEOS_MAKE_PATH)/instance.mk
          after-install::
              install.exec "killall -9 $(INSTALL_TARGET_PROCESSES)"
          EOF
          
          # 安装依赖工具
          brew install ldid make
          echo "Theos 核心环境搭建完成"

      - name: 编译插件
        run: |
          make clean THEOS="$HOME/theos"
          make package THEOS="$HOME/theos"

      - name: 上传产物
        uses: actions/upload-artifact@v4
        with:
          name: tweak-deb
          path: packages/*.deb
