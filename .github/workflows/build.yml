name: Build iOS 15 Tweak
on: [push]

jobs:
  build:
    runs-on: macos-latest
    steps:
      - name: 拉取代码
        uses: actions/checkout@v4

      - name: 安装所有依赖
        run: |
          xcode-select --install || true
          brew install ldid dpkg clang
          # 克隆 Theos 仅用于获取必要的头文件和库
          git clone --depth 1 https://github.com/theos/theos.git $HOME/theos

      - name: 准备编译环境
        run: |
          # 确保系统 SDK 可用
          SDK_PATH=$(xcode-select -p)/Platforms/iPhoneOS.platform/Developer/SDKs/iPhoneOS.sdk
          echo "SDK_PATH=$SDK_PATH" >> $GITHUB_ENV
          
          # 复制 Theos 头文件（确保 Hook 函数可用）
          cp -r $HOME/theos/vendor/include/* /usr/local/include/
          
          # 准备 ElleKit 替代 substrate（iOS 15 兼容）
          mkdir -p $HOME/lib
          curl -fL --insecure https://github.com/coolstar/ElleKit/releases/download/1.1.1/ElleKit.framework.zip -o $HOME/ElleKit.framework.zip
          unzip $HOME/ElleKit.framework.zip -d $HOME/
          cp $HOME/ElleKit.framework/ElleKit $HOME/lib/libsubstrate.dylib
          cp $HOME/ElleKit.framework/Headers/ElleKit.h /usr/local/include/substrate.h

      - name: 手动编译插件
        run: |
          # 编译动态库（直接指定所有参数）
          clang -dynamiclib -arch arm64 -isysroot ${{ env.SDK_PATH }} \
          -framework Foundation -framework UIKit \
          -I/usr/local/include -L$HOME/lib \
          -lsubstrate -fobjc-arc -x objective-c++ \
          Tweak.xm -o VirtualCamera.dylib
          
          # 签名动态库
          ldid -S VirtualCamera.dylib
          
          # 打包成 deb
          mkdir -p packages/DEBIAN
          mkdir -p packages/Library/MobileSubstrate/DynamicLibraries
          cp VirtualCamera.dylib packages/Library/MobileSubstrate/DynamicLibraries/
          cp control packages/DEBIAN/
          dpkg-deb -b packages VirtualCamera_1.0.0_iphoneos-arm64.deb

      - name: 上传产物
        uses: actions/upload-artifact@v4
        with:
          name: ios15-tweak-deb
          path: ./*.deb
